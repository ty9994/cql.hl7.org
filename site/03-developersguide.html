<!DOCTYPE html>
<!-- saved from url=(0043)http://hl7.org/fhir/2016May/FHIRPath.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

  <title>3. Developer’s Guide</title>

  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <meta content="http://cql.hl7.org" name="author"/>

  <link rel="stylesheet" href="dist/fhir.css"/>
  <link rel="Prev" href="history.html"/>

    <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="dist/bootstrap.css"/>
  <link rel="stylesheet" href="dist/bootstrap-fhir.css"/>

    <!-- Project extras -->
  <link rel="stylesheet" href="dist/project.css"/>
  <link rel="stylesheet" href="dist/prism.css"/>
  <link rel="stylesheet" href="dist/pygments-manni.css"/>
	<link rel="stylesheet" href="dist/jquery-ui.css"/>
	<link rel="stylesheet" href="dist/cql.css"/>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- [if lt IE 9]>
  <script src="./assets/js/html5shiv.js"></script>
  <script src="./assets/js/respond.min.js"></script>
  <![endif] -->

    <!-- Favicons -->
  <link sizes="144x144" rel="apple-touch-icon-precomposed" href="dist/apple-touch-icon-144-precomposed.png"/>
  <link sizes="114x114" rel="apple-touch-icon-precomposed" href="dist/apple-touch-icon-114-precomposed.png"/>
  <link sizes="72x72" rel="apple-touch-icon-precomposed" href="dist/apple-touch-icon-72-precomposed.png"/>
  <link rel="apple-touch-icon-precomposed" href="dist/apple-touch-icon-57-precomposed.png"/>
  <link rel="shortcut icon" href="dist/favicon.png"/>

</head>
<body data-feedly-mini="yes">
	<div id="segment-header" class="segment">  <!-- segment-header -->
		<div class="container">  <!-- container -->
			<a id="logo" no-external="true" href="index.html"><img alt="Clinical Quality Language" src="dist/cql-logo.png" width="100" height="75"/> </a>
			<div id="hl7-status">
				<b>Clinical Quality Language Release 1</b>
			</div>

			<div id="hl7-nav">
				 <a id="hl7-logo" no-external="true" href="http://www.hl7.org/">
					<img height="75" alt="visit the hl7 website" width="100" src="dist/hl7-logo.png"/>
				</a>
			</div>
			<!--<div id="hl7-nav"><a id="hl7-logo" no-external="true" href="http://cql.hl7.org/search.cfm"><img alt="Search CQL" src="dist/search.png"/></a></div>-->
		</div>
		<div class="container">  <!-- container -->
	</div></div>  <!-- /segment-header -->

	<div id="segment-navbar" class="segment">  <!-- segment-navbar -->
		<div id="stripe"> </div>
		<div class="container">  <!-- container -->
   <!-- HEADER CONTENT -->


			<nav class="navbar navbar-inverse">
				<div class="container">
					<button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
						<span class="icon-bar"> </span>
						<span class="icon-bar"> </span>
						<span class="icon-bar"> </span>
					</button>
					<a class="navbar-brand hidden" href="index.html">CQL</a>
					<div class="nav-collapse collapse navbar-inverse-collapse">
						<ul class="nav navbar-nav">
              <li class = "dropdown">
				  <a href="index.html" class = "dropbtn">Documentation</a>
			  <div class = "dropdown-content">
				  <a href="01-introduction.html">Chapter 1 - Introduction</a>
				  <a href="02-authorsguide.html">Chapter 2 - Author's Guide</a>
				  <a href="03-developersguide.html">Chapter 3 - Developer's Guide</a>
				  <a href="04-logicalspecification.html">Chapter 4 - Logical Specification</a>
				  <a href="05-languagesemantics.html">Chapter 5 - Language Semantics</a>
				  <a href="06-translationsemantics.html">Chapter 6 - Translation Semantics</a>
				  <a href="07-physicalrepresentation.html">Chapter 7 - Physical Representation</a>
				  <a href="08-a-cqlsyntax.html">Appendix A - CQL Syntax Formal Specification</a>
				  <a href="09-b-cqlreference.html">Appendix B - CQL Reference</a>
				  <a href="10-c-referenceimplementations.html">Appendix C - Reference Implementations</a>
				  <a href="11-d-references.html">Appendix D - References</a>
				  <a href="12-e-acronyms.html">Appendix E - Acronyms</a>
				  <a href="13-f-glossary.html">Appendix F - Glossary</a>
				  <a href="14-g-formattingconventions.html">Appendix G - Conventions</a>
				  <a href="15-h-timeintervalcalculations.html">Appendix H - Time Interval Calculation Examples</a>
				  <a href="16-i-fhirpathtranslation.html">Appendix I - FHIRPath Function Translation</a>
				  <a href="17-j-listoftables.html">Appendix J - List Of Tables</a>
				  <a href="18-k-listoffigures.html">Appendix K - List Of Figures</a>
          <a href="19-l-cqlsyntaxdiagrams.html">Appendix L - CQL Syntax Diagrams</a>
			  </div>
			  </li>
        <li><a href="02-authorsguide.html">Author's Guide</a></li>
        <li><a href="03-developersguide.html">Developer's Guide</a></li>
        <li><a href="09-b-cqlreference.html">CQL Reference</a></li>
              <li><a href="grammar.html">Grammar</a></li>
			  <li><a href="elm.html">ELM</a></li>
			  <li><a href="examples.html">Examples</a></li>
              <li><a href="tests.html">Tests</a></li>
							<li><a href="downloads.html">Downloads</a></li>
              <li><a href="http://cql.hl7.org/history.html">Version History</a><!--current--></li>

						</ul>
					</div>  <!-- /.nav-collapse -->

          </div>  <!-- /.container -->
			</nav>  <!-- /.navbar -->


  <!-- /HEADER CONTENT -->
		</div>  <!-- /container -->
	</div>  <!-- /segment-navbar -->

	<div id="segment-content" class="segment">  <!-- segment-content -->
	<div class="container">  <!-- container -->
            <div class="row">
            	<div class="inner-wrapper">
  <!-- CONTENT CONTENT -->


<div class="col-9">

<!--ReleaseHeader--><p id="publish-box">Publication Build: This will be filled in by the publication tooling</p><!--EndReleaseHeader-->


<table class="colsn"><tbody><tr><td id="wg"><a href="http://www.hl7.org/special/committees/dss/index.cfm" _target="blank">Clinical Decision Support</a> Work Group</td><td id="fmm"><a href="http://hl7.org/fhir/versions.html#maturity">Maturity Level</a>: N</td><td id="ballot"><a href="http://hl7.org/fhir/versions.html#std-process">Standards Status</a>: <a style="padding-left: 3px; padding-right: 3px; color: black;" title="Unless otherwise specified explicitly, content on this page is normative.">Normative</a></td></tr></tbody></table>


	<h1>3. Developer’s Guide</h1>



	<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#lexical-elements">1. Lexical Elements</a>
<ul class="sectlevel2">
<li><a href="#whitespace">1.1. Whitespace</a></li>
<li><a href="#comments">1.2. Comments</a></li>
<li><a href="#literals">1.3. Literals</a></li>
<li><a href="#symbols">1.4. Symbols</a></li>
<li><a href="#keywords">1.5. Keywords</a></li>
<li><a href="#reserved-words">1.6. Reserved Words</a></li>
<li><a href="#identifiers">1.7. Identifiers</a></li>
<li><a href="#operator-precedence">1.8. Operator Precedence</a></li>
<li><a href="#case-sensitivity">1.9. Case-Sensitivity</a></li>
</ul>
</li>
<li><a href="#libraries-1">2. Libraries</a>
<ul class="sectlevel2">
<li><a href="#access-modifiers">2.1. Access Modifiers</a></li>
<li><a href="#identifier-resolution">2.2. Identifier Resolution</a></li>
<li><a href="#function-resolution">2.3. Function Resolution</a></li>
</ul>
</li>
<li><a href="#data-models-1">3. Data Models</a>
<ul class="sectlevel2">
<li><a href="#alternate-data-models">3.1. Alternate Data Models</a></li>
<li><a href="#multiple-data-models">3.2. Multiple Data Models</a></li>
</ul>
</li>
<li><a href="#types">4. Types</a>
<ul class="sectlevel2">
<li><a href="#system-defined-types">4.1. System-Defined Types</a></li>
<li><a href="#specifying-types">4.2. Specifying Types</a></li>
<li><a href="#type-testing">4.3. Type Testing</a></li>
<li><a href="#choice-types">4.4. Choice Types</a></li>
<li><a href="#type-inference">4.5. Type Inference</a></li>
<li><a href="#conversion">4.6. Conversion</a></li>
<li><a href="#casting">4.7. Casting</a></li>
<li><a href="#promotion-and-demotion">4.8. Promotion and Demotion</a></li>
<li><a href="#conversion-precedence">4.9. Conversion Precedence</a></li>
</ul>
</li>
<li><a href="#conditional-expressions">5. Conditional Expressions</a></li>
<li><a href="#nullological-operators">6. Nullological Operators</a></li>
<li><a href="#string-operators">7. String Operators</a></li>
<li><a href="#introducing-context-in-queries">8. Introducing Scoped Definitions in Queries</a></li>
<li><a href="#multi-source-queries">9. Multi-Source Queries</a>
<ul class="sectlevel2">
<li><a href="#query-syntax-options">9.1. Query Syntax Options</a></li>
</ul>
</li>
<li><a href="#non-retrieve-queries">10. Non-Retrieve Queries</a></li>
<li><a href="#related-context-retrieves">11. Related Context Retrieves</a></li>
<li><a href="#aggregate-queries">12. Aggregate Queries</a></li>
<li><a href="#defining-functions">13. Defining Functions</a>
<ul class="sectlevel2">
<li><a href="#operator-functions">13.1. Operator Functions</a></li>
<li><a href="#fluent-functions">13.2. Fluent Functions</a></li>
<li><a href="#external-functions">13.3. External Functions</a></li>
</ul>
</li>
<li><a href="#using-fhirpath">14. Using FHIRPath</a>
<ul class="sectlevel2">
<li><a href="#path-traversal">14.1. Path Traversal</a></li>
<li><a href="#list-promotion-and-demotion">14.2. List Promotion and Demotion</a></li>
<li><a href="#missing-information-1">14.3. Missing Information</a></li>
<li><a href="#type-resolution">14.4. Type Resolution</a></li>
<li><a href="#method-invocation">14.5. Method Invocation</a></li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter complements the Author’s Guide by providing more in-depth discussion of language elements, semantics, more complex query scenarios, and more advanced topics such as typing and function definition. Readers are expected to be familiar with the content of the <a href="02-authorsguide.html">Author’s Guide</a> in the discussions that follow.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lexical-elements"><a class="anchor" href="#lexical-elements"></a>1. Lexical Elements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CQL is intended to be an authoring language. As such, the syntax is designed to be intuitive and clear, both when writing and reading the language. Care has been taken to ensure that the language contains a simple and clear core set of language elements, and that they all interact in a consistent and predictable manner.</p>
</div>
<div class="paragraph">
<p>As with any traditional computer language, CQL uses typical lexical elements such as whitespace, keywords, symbols, comments, and so on.</p>
</div>
<div class="paragraph">
<p>CQL defines the following basic lexical elements:</p>
</div>
<table id="table-3-a" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Whitespace</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whitespace defines the separation between all tokens in the language</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Comment</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comments are ignored by the language, allowing for descriptive text</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Literal</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Literals allow basic values to be represented within the language</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Symbol</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Symbols such as <span class="sym">+</span>, <span class="sym">-</span>, <span class="sym">*</span>, and <span class="sym">/</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Keyword</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Grammar-recognized keywords such as define and where</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Identifier</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User-defined identifiers</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑A - The basic lexical elements defined in CQL</p>
</div>
<div class="paragraph">
<p>Every valid CQL document can be broken down into a set of tokens, each of which is one of these basic lexical elements. The following sections describe each of these elements in more detail.</p>
</div>
<div class="sect2">
<h3 id="whitespace"><a class="anchor" href="#whitespace"></a>1.1. Whitespace</h3>
<div class="paragraph">
<p>CQL defines <em>tab</em>, <em>space</em>, and <em>return</em> as <em>whitespace</em>, meaning they are only used to separate other tokens within the language. Any number of whitespace characters can appear, and the language does not use whitespace for anything other than delimiting tokens.</p>
</div>
</div>
<div class="sect2">
<h3 id="comments"><a class="anchor" href="#comments"></a>1.2. Comments</h3>
<div class="paragraph">
<p>CQL defines two styles of comments, <em>single-line</em>, and <em>multi-line</em>. A single-line comment consists of two forward slashes, followed by any text up to the end of the line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Foo": 1 + 1 // This is a single-line comment</code></pre>
</div>
</div>
<div class="paragraph">
<p>To begin a multi-line comment, the typical forward slash-asterisk token is used. The comment is closed with an asterisk-forward slash, and everything enclosed is ignored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">/*
This is a multi-line comment
Any text enclosed within is ignored
*/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that nested multi-line comments are not supported.</p>
</div>
<div class="sect3">
<h4 id="tags"><a class="anchor" href="#tags"></a>1.2.1. Tags</h4>
<div class="quoteblock note-info">
<blockquote>
<div class="paragraph">
<p>Comment tags are a new feature of CQL 1.5, and are trial-use</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Within multi-line comments, CQL supports the ability to define <em>tags</em> that will be associated with the declaration on which they appear. Tags are defined in comments immediately preceding the declaration to which they apply using the <code>@</code> symbol, followed by a valid, unquoted identifier, followed by a colon (<code>:</code>). For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">/*
@author: Frederic Chopin
@description: Defines whether the patient is included in the initial population
*/
define "InInitialPopulation":
  AgeInYearsAt(start of MeasurementPeriod) &gt;= 16
    and AgeInYearsAt(start of MeasurementPeriod) &lt; 24
    and Patient.gender in "Female Administrative Sex"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contents of the resulting tag will be whatever comes after the tag definition until the next tag or the end of the comment-block, whatever comes first.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">/*
@author: Ludwig van Beethoven
@description: Determines the cumulative duration of a list of intervals
@comment: This function collapses the input intervals prior to determining the cumulative duration
to ensure overlapping intervals do not contribute multiple times to the result
 */
define function "CumulativeDuration"(Intervals List&lt;Interval&lt;DateTime&gt;&gt;):
  Sum((collapse Intervals) X return all duration in days of X)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="literals"><a class="anchor" href="#literals"></a>1.3. Literals</h3>
<div class="paragraph">
<p>Literals provide for the representation of basic values within CQL. The following types of literals are supported:</p>
</div>
<table id="table-3-b" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Literal</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Null</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The null literal (<span class="kw">null</span>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Boolean</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The boolean literals (<span class="kw">true</span> and <span class="kw">false</span>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Integer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequences of digits in the range 0..2<sup>31</sup>-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Long</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequences of digits in the range 0..2<sup>63</sup>-1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Decimal</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sequences of digits with a decimal point, in the range 0.0.. (10<sup>28</sup>-1)/10<sup>8</sup></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>String</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strings of any character enclosed within single-ticks (<span class="lit">'</span>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Date</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The at-symbol (<span class="sym">@</span>) followed by an ISO-8601 compliant representation of a date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DateTime</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The at-symbol (<span class="sym">@</span>) followed by an ISO-8601 compliant representation of a datetime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Time</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The at-symbol (<span class="sym">@</span>) followed by an ISO-8601 compliant representation of a time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Quantity</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An integer or decimal literal followed by a datetime precision specifier, or a UCUM unit specifier</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Ratio</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A ratio of two quantities, separated by a colon (<span class="sym">:</span>)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑B - The types of literals supported in CQL</p>
</div>
<div class="paragraph">
<p>A syntax diagram of the types of literals supported can be seen <a href="19-l-cqlsyntaxdiagrams.html#literal">here</a>.</p>
</div>
<div class="paragraph">
<p>CQL uses standard escape sequences for string literals:</p>
</div>
<table id="table-3-c" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Escape</th>
<th class="tableblock halign-left valign-top">Character</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single-quote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double-quote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\`</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backtick</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Carriage Return</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\n</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line Feed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\t</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tab</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Form Feed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\\</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backslash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">\uXXXX</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unicode character, where XXXX is the hexadecimal representation of the character</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑C - The escape sequences for string literals in CQL</p>
</div>
<div class="paragraph">
<p>A syntax diagram of the standard escape sequences for string literals supported can be seen <a href="19-l-cqlsyntaxdiagrams.html#ESC">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="symbols"><a class="anchor" href="#symbols"></a>1.4. Symbols</h3>
<div class="paragraph">
<p>Symbols provide structure to the grammar and allow symbolic invocation of common operators such as addition. CQL defines the following symbols:</p>
</div>
<table id="table-3-d" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Symbol</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>:</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition operator, typically read as “defined as”. Also used to separate the numerator from denominator in Ratio literals</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>()</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parentheses for delimiting groups, as well as specifying and passing function parameters</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>[]</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Brackets for indexing into lists and strings, as well as delimiting the retrieve expression</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>{}</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Braces for delimiting lists and tuples</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&lt;&gt;</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Angle-brackets for delimiting generic types within type specifiers</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>.</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Period for qualifiers and accessors</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>,</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma for delimiting items in a syntactic list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>= != &lt;= &lt; &gt; &gt;=</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison operators for comparing values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>+ - * / ^</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic operators for performing calculations</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑D - The symbols supported by CQL to provide structure to the grammar and allow symbolic invocation of common operators such as addition</p>
</div>
</div>
<div class="sect2">
<h3 id="keywords"><a class="anchor" href="#keywords"></a>1.5. Keywords</h3>
<div class="paragraph">
<p>Keywords are words that are recognized by the parser and used to build the various language constructs. CQL defines the following keywords:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">after
aggregate
all
and
as
asc
ascending
before
between
by
called
case
cast
code
Code
codesystem
codesystems
collapse
concept
Concept
contains
context
convert
date
day
days
default
define
desc
descending
difference
display
distinct
div
duration
during
else
end
ends
except
exists
expand
false
flatten
fluent
from
function
hour
hours
if
implies
in
include
includes
included in
intersect
Interval
is
let
library
List
maximum
meets
millisecond
milliseconds
minimum
minute
minutes
mod
month
months
not
null
occurs
of
on
or
or after
or before
or less
or more
or on
overlaps
parameter
per
point
predecessor
private
properly
public
return
same
singleton
second
seconds
start
starting
starts
sort
successor
such that
then
time
timezoneoffset
to
true
Tuple
union
using
valueset
version
week
weeks
where
when
width
with
within
without
xor
year
years</code></pre>
</div>
</div>
<div class="paragraph">
<p>A syntax diagram of the keywords supported can be seen <a href="19-l-cqlsyntaxdiagrams.html#keyword">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="reserved-words"><a class="anchor" href="#reserved-words"></a>1.6. Reserved Words</h3>
<div class="paragraph">
<p>When there is no possibility for ambiguity, keywords may also be used as identifiers. However, many keywords are considered <em>reserved</em> words, meaning that it is illegal to use them as identifiers. If necessary, identifiers that clash with a reserved word can be double-quoted or surrounded by backticks (<code> ` </code>).</p>
</div>
<div class="paragraph">
<p>The following keywords are defined as reserved words:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">aggregate
all
and
as
after
before
between
case
cast
Code
collapse
Concept
convert
day
days
difference
distinct
duration
during
else
exists
expand
false
flatten
from
if
in
included in
is
hour
hours
Interval
let
List
maximum
millisecond
milliseconds
minimum
minute
minutes
month
months
not
null
occurs
of
on or
or
or on
per
properly
return
same
second
seconds
singleton
sort
such that
then
to
true
Tuple
week
weeks
when
with
within
without
year
years</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that most reserved words may still be used as identifiers if the usage is unambiguous. For example, <span class="kw">exists</span> is a reserved word, but because the use of parentheses is required for function invocation, it can still be distinguished as a function identifier.</p>
</div>
<div class="paragraph">
<p>In addition, even though many keywords are allowed to appear as identifiers, this feature of the language is about avoiding naming clashes with data models used in CQL, and several places in the grammar do not allow keywords or reserved words to be used as identifiers. For example, named expressions, terminology declarations, aliases, and let clauses cannot use keywords or reserved words as identifiers.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of the <em>reserved</em> words supported can be seen <a href="19-l-cqlsyntaxdiagrams.html#reservedWord">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="identifiers"><a class="anchor" href="#identifiers"></a>1.7. Identifiers</h3>
<div class="paragraph">
<p>Identifiers are used to name various elements within the language. There are three types of identifiers in CQL, simple, delimited, and quoted.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of the types of <em>identifiers</em> in CQL can be seen <a href="19-l-cqlsyntaxdiagrams.html#identifier">here</a>.</p>
</div>
<div class="paragraph">
<p>A simple identifier is any alphabetical character or an underscore, followed by any number of alpha-numeric characters or underscores. For example, the following are all valid simple identifiers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Foo
Foo1
_Foo
foo
FOO</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note also that these are all unique identifiers. By convention, simple identifiers in CQL should not begin with underscores, and should be Pascal-cased (meaning the first letter of every word within the identifier is capitalized), rather than using underscores.</p>
</div>
<div class="paragraph">
<p>In particular, the use of identifiers that differ only in case should be avoided.</p>
</div>
<div class="paragraph">
<p>A delimited identifier is any sequence of characters enclosed in backticks (<span class="sym">`</span>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">`Encounter, Performed`
`Diagnosis`</code></pre>
</div>
</div>
<div class="paragraph">
<p>A quoted identifier is any sequence of characters enclosed in double-quotes (<span class="sym">"</span>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">"Encounter, Performed"
"Diagnosis"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of double-quotes and backticks allows identifiers to contain spaces, commas, and other characters that would not be allowed within simple identifiers. This allows identifiers within CQL to be much more descriptive and readable.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of quoted identifier can be seen <a href="19-l-cqlsyntaxdiagrams.html#QUOTEDIDENTIFIER">here</a>.</p>
</div>
<div class="paragraph">
<p>To specify a quoted or delimited identifier that includes a double-quote (<span class="sym">"</span>) or backtick (<span class="sym">`</span>), use a backslash to escape the delimiter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">"Encounter \"Inpatient\""</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that double-quoted and delimited identifiers are still case-sensitive, and as with simple identifiers, the use of identifiers that differ only in case should be avoided. The enclosing delimiter marks are not included in the defined identifier.</p>
</div>
<div class="paragraph">
<p>CQL escape sequences for strings also work for identifiers:</p>
</div>
<table id="table-3-e" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Escape</th>
<th class="tableblock halign-left valign-top">Character</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\'</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single-quote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\"</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Double-quote</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\`</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backtick</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\r</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Carriage Return</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\n</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Line Feed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\t</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tab</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\f</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Form Feed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\\</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backslash</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>\uXXXX</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unicode character, where XXXX is the hexadecimal representation of the character</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑E - The escape sequences for identifiers in CQL</p>
</div>
<div class="sect3">
<h4 id="qualified-identifiers"><a class="anchor" href="#qualified-identifiers"></a>1.7.1. Qualified Identifiers</h4>
<div class="paragraph">
<p>Identifiers can be combined using the <em>qualifier</em> operator (<span class="sym">.</span>), resulting in a <em>qualified identifier</em>. For example <span class="id">Common.ConditionsIndicatingSexualActivity</span>. An identifier with no qualifiers is an <em>unqualified identifier</em>.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of a <em>qualified identifier</em> can be seen <a href="19-l-cqlsyntaxdiagrams.html#qualifiedIdentifier">here</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="operator-precedence"><a class="anchor" href="#operator-precedence"></a>1.8. Operator Precedence</h3>
<div class="paragraph">
<p>CQL uses standard in-fix operator notation for expressing computational logic. As a result, CQL also adopts the expected operator precedence to ensure consistent and predictable behavior of expressions written using CQL. The following table lists the order of operator precedence in CQL from highest to lowest:</p>
</div>
<table id="table-3-f" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Category</th>
<th class="tableblock halign-left valign-top">Operators</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Primary</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="sym">.</span> <span class="sym">[]</span> <span class="sym">()</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Conversion Phrase</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">convert</span>..<span class="kw">to</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Unary Arithmetic</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">unary <span class="sym">+/-</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Extractor</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">start</span> <span class="kw">end</span> <span class="kw">difference</span> <span class="kw">duration</span> <span class="kw">width</span> <span class="kw">successor</span> <span class="kw">predecessor of</span><br/>
<em>component</em> <span class="kw">singleton from</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Exponentiation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="sym">^</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Multiplicative</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="sym">*</span> <span class="sym">/</span> <span class="kw">div mod</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Additive</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="sym">+</span> <span class="sym">-</span> <span class="sym">&amp;</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Conditional</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">if</span>..<span class="kw">then</span>..<span class="kw">else</span><br/>
<span class="kw">case</span>..<span class="kw">else</span>..<span class="kw">end</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Unary List</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">distinct</span> <span class="kw">collapse</span> <span class="kw">flatten</span> <span class="kw">expand</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Unary Test</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">is null</span> <span class="kw">true</span> <span class="kw">false</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Type Operators</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">is as cast</span>..<span class="kw">as</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Unary Logical</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">not exists</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Between</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">between</span><br/>
<em>precision</em> <span class="kw">between</span><br/>
<span class="kw">duration in</span> <em>precision</em> <span class="kw">between</span><br/>
<span class="kw">difference in</span> <em>precision</em> <span class="kw">between</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Comparison</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="sym">&lt;=</span> <span class="sym">&lt;</span> <span class="sym">&gt;</span> <span class="sym">&gt;=</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Timing Phrase</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">same as</span><br/>
<span class="kw">includes</span><br/>
<span class="kw">during</span><br/>
<span class="kw">before/after</span><br/>
<span class="kw">within</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Interval Operators</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">meets overlaps starts ends</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Equality</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="sym">=</span> <span class="sym">!=</span> <span class="sym">~</span> <span class="sym">!~</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Membership</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">in contains</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Conjunction</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">and</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Disjunction</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">or xor</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Implication</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">implies</span></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Binary List</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><span class="kw">union intersect except</span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑F - The order of operator precedence in CQL</p>
</div>
<div class="paragraph">
<p>As with most expression languages, parentheses can always be used to force order-of-operations if the defined operator precedence does not produce the intended evaluation of a given expression.</p>
</div>
<div class="paragraph">
<p>When multiple operators appear in a single category, precedence is determined by the order of appearance in the expression, left to right.</p>
</div>
</div>
<div class="sect2">
<h3 id="case-sensitivity"><a class="anchor" href="#case-sensitivity"></a>1.9. Case-Sensitivity</h3>
<div class="paragraph">
<p>To encourage consistency and reduce potential confusion, CQL is a case-sensitive language. This means that case is considered when matching keywords and identifiers in the language. For example, the following CQL is invalid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Define "Foo": 1 + 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The declaration is illegal because the parser will not recognize <span class="kw">Define</span> as a keyword.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="libraries-1"><a class="anchor" href="#libraries-1"></a>2. Libraries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Libraries provide the basic unit of code organization for CQL. Each CQL file contains a single library, and may include any number of libraries by reference, subject to the following constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The local <a href="#identifiers">identifier</a> for a referenced library must be <a href="#qualified-identifiers">unqualified</a> and unique within the artifact.</p>
</li>
<li>
<p>Circular library references are not allowed.</p>
</li>
<li>
<p>Library references are not transitive.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A syntax diagram of a library construct can be seen <a href="19-l-cqlsyntaxdiagrams.html#library">here</a>.</p>
</div>
<div class="paragraph">
<p>Library identifiers may be qualified to any degree to allow libraries to be organized and shared. In addition, the ELM for a <a href="04-logicalspecification.html#library">library</a> contains an identifier element with a namespace which provides a globally unique, stable identifier scope for the library. All the library identifiers within a given namespace must be unique, and the namespace is used by the implementation environment to resolve library identifiers to their actual library source. See the <a href="examples.html#mother-infant-measure">Mother Infant Measure</a> for an example of how namespaces are specified in ELM.</p>
</div>
<div class="paragraph">
<p>When including a library, use the fully qualified identifier for the library. If the <span class="kw">called</span> clause is omitted from the include declaration, the unqualified library identifier will be used as the local identifier for the library.</p>
</div>
<div class="paragraph">
<p>Because the library identifier and its qualifiers are CQL identifiers, they may be either a simple identifier, or a delimited-identifier, which may actually be a uniform resource identifier (URI), an object identifier (OID), or any other identifier system. It is up to the implementation and environment what interpretation, if any, is given to the identifier of a library. For example, assume a library identified as <span class="id">Global.Common</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">library Global.Common

define function "Foo"(A Integer, B Integer):
  A + B</code></pre>
</div>
</div>
<div class="paragraph">
<p>When including this library, the <span class="kw">called</span> clause may be omitted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">library UsingCommon

include Global.Common

define function "Bar"(A Integer, B Integer):
  Common.Foo(A, B)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Libraries may also be declared with a specific version. When referencing a library, the reference may include a version specifier. If the reference includes a version specifier, the library with that version specifier must be used. If the reference does not include a version specifier, it is up to the implementation environment to provide the most appropriate version of the referenced library.</p>
</div>
<div class="paragraph">
<p>It is an error to reference a specific version of a library if the library does not have a version specifier, or if there is no library with the referenced version.</p>
</div>
<div class="paragraph">
<p>Note that the library declaration is optional in a CQL document, but if it is omitted, it is not possible to reference the library from any other CQL library.</p>
</div>
<div class="paragraph">
<p>Libraries may reference other libraries to any degree of nesting, so long as no circular library references are introduced, and all references to the same library use the same version. For example, given:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">library A version '1'
library A version '2'

library B includes library A version '1'
library C includes library A version '2'</code></pre>
</div>
</div>
<div class="paragraph">
<p>A library D may not reference both B and C, because it would result in two different versions of library A being referenced.</p>
</div>
<div class="paragraph">
<p>In addition, library references are not transitive, meaning that in order to reference the components declared within a particular library, the library must be explicitly included. In other words, referencing a library does not automatically include libraries referenced by that library.</p>
</div>
<div class="sect2">
<h3 id="access-modifiers"><a class="anchor" href="#access-modifiers"></a>2.1. Access Modifiers</h3>
<div class="paragraph">
<p>Each component of a library may have an access modifier applied, either <span class="kw">public</span> or <span class="kw">private</span>. If no access modifier is applied, the component is considered public. Only public components of a library may be accessed by referencing libraries. Private components can only be accessed within the library itself.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of the access modifiers can be seen <a href="19-l-cqlsyntaxdiagrams.html#accessModifier">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="identifier-resolution"><a class="anchor" href="#identifier-resolution"></a>2.2. Identifier Resolution</h3>
<div class="paragraph">
<p>For identifiers, if a library name is not provided, the identifier must refer to a locally or system defined component. If a library name is provided, it must be the local identifier for the library, and that library must contain the identifier being referenced.</p>
</div>
<div class="paragraph">
<p>For named expressions, CQL supports forward declarations, so long as the resolution does not result in a circular definition.</p>
</div>
</div>
<div class="sect2">
<h3 id="function-resolution"><a class="anchor" href="#function-resolution"></a>2.3. Function Resolution</h3>
<div class="paragraph">
<p>For functions, if a library name is not provided, the invocation must refer to a locally defined function, or a CQL system function. Function resolution proceeds by attempting to match the <em>signature</em> of the invocation, i.e. the number and type of each argument, to a defined signature for the function. Because the CQL type system supports subtyping, generics, and implicit conversion and casting, it is possible for an invocation signature to match multiple defined signatures. In these cases, the <em>least converting</em> signature is chosen, meaning the signature with the fewest required conversions. If multiple signatures have the same number of required conversions, an ambiguous resolution error is thrown, and the author must provide an explicit cast or conversion to resolve the ambiguity.</p>
</div>
<div class="paragraph">
<p>If a library name is provided, only that library will be searched for a resolution.</p>
</div>
<div class="paragraph">
<p>As with expressions, CQL supports forward declarations for functions, so long as the reference does not result in a cycle.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-models-1"><a class="anchor" href="#data-models-1"></a>3. Data Models</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CQL allows any number of data models to be included in a given library, subject to the following constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The data model identifier must be unique, both among data models, as well as libraries.</p>
</li>
<li>
<p>Data model references are not included from referenced libraries. To reference the data types in a data model, an appropriate local using declaration must be specified.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As with library references, data model references may include a version specifier. If a version is specified, then the environment must ensure that the version specifier matches the version of the data model supplied. If no data model matching the requested version is present, an error is thrown.</p>
</div>
<div class="sect2">
<h3 id="alternate-data-models"><a class="anchor" href="#alternate-data-models"></a>3.1. Alternate Data Models</h3>
<div class="paragraph">
<p>Although the examples in this specification generally use the QUICK model (part of the Clinical Quality Framework), CQL itself does not require or depend on a specific data model. For example, the following sample is taken from the CMS146v2_using_QDM.cql file in the Examples section of the specification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">["Encounter, Performed": "Ambulatory/ED Visit"] E
  with ["Diagnosis": "Acute Pharyngitis"] P such that
    interval[P."start datetime", P."stop datetime")
      overlaps after interval[E."start datetime", E."stop datetime")</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, QDM is used as the data model. Note the use of quoted attribute identifiers to allow for the spaces in the names of QDM attributes.</p>
</div>
</div>
<div class="sect2">
<h3 id="multiple-data-models"><a class="anchor" href="#multiple-data-models"></a>3.2. Multiple Data Models</h3>
<div class="paragraph">
<p>Because CQL allows multiple <span class="kw">using</span> declarations, the possibility exists for clashes within retrieve expressions. For example, a library that used both QUICK and vMR may clash on the name <span class="id">Encounter</span>. In general, the resolution process for class names within CQL proceeds as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If the class name has no qualifier, then each model used in the current library is searched for an exact match.</p>
<div class="ulist">
<ul>
<li>
<p>If an exact match is found in more than one model, the reference is considered ambiguous and an error is thrown that the class reference is ambiguous among the matches found.</p>
</li>
<li>
<p>If an exact match is found in only one model, that model and type is used.</p>
</li>
<li>
<p>If no match is found in any model, an error is thrown that the referenced name cannot be resolved.</p>
</li>
</ul>
</div>
</li>
<li>
<p>If the class name has a qualifier, then the qualifier specifies the model to be searched, and only that model is used to attempt a resolution.</p>
<div class="ulist">
<ul>
<li>
<p>If the qualifier specifies the name of a model that cannot be found in the current library, an error is thrown that the referenced model cannot be found.</p>
</li>
<li>
<p>If an exact match is found in the referenced model, that class is used.</p>
</li>
<li>
<p>If no exact match is found, an error is thrown that the qualified class name cannot be resolved.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="types"><a class="anchor" href="#types"></a>4. Types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CQL is a statically typed language, meaning that it is possible to infer the type of any given expression, and for any given operator invocation, the type of the arguments must match the types of the operands. To provide complete support for the type system, CQL supports several constructs for dealing with types including <em>type specifiers</em>, as well as <em>conversion</em>, <em>casting</em>, and <em>type-testing</em> operators.</p>
</div>
<div class="paragraph">
<p>CQL uses a single-inheritance type system, meaning that each type is derived from at most one type. Given a type T and a type T' derived from type T, the following statements are true:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The type T is a <em>supertype</em> of type T'.</p>
</li>
<li>
<p>The type T' is a <em>subtype</em> of type T.</p>
</li>
<li>
<p>A value of type T' may appear anywhere a value of type T is expected.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="system-defined-types"><a class="anchor" href="#system-defined-types"></a>4.1. System-Defined Types</h3>
<div class="paragraph">
<p>CQL defines several base types that provide the elements for constructing other types, as well as for defining the operations available within the language.</p>
</div>
<div class="paragraph">
<p>The maximal supertype is System.Any. All other types derive from System.Any, meaning that any value is of some type, and also ultimately of type System.Any.</p>
</div>
<div class="paragraph">
<p>All the system-defined types derive directly from System.Any. The primitive types and their ranges are summarized here:</p>
</div>
<table id="table-3-g" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;"/>
<col style="width: 33.3333%;"/>
<col style="width: 33.3334%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Range</th>
<th class="tableblock halign-left valign-top">Step Size</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Boolean</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false..true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Integer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-2<sup>31</sup>..2<sup>31</sup>–1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Long</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-2<sup>63</sup>..2<sup>63</sup>-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Date</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@0001-01-01..@9999-12-31</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 day</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DateTime</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@0001-01-01T00:00:00.0..@9999-12-31T23:59:59.999</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 millisecond</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Decimal</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">(-10<sup>28</sup>+1)/10<sup>8</sup>..(10<sup>28</sup>-1)/10<sup>8</sup></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10<sup>-8</sup></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>String</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All strings of length 2<sup>31</sup>-1 or less.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Time</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">@T00:00:00.0..@T23:59:59.999</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 millisecond</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑G - The primitive types and their ranges supported in CQL</p>
</div>
<div class="paragraph">
<p>Note that CQL supports three-valued logic, see the section on <a href="02-authorsguide.html#missing-information">Missing Information</a> in the Author&#8217;s Guide, as well as the section on <a href="#missing-information-1">Missing Information</a> in the Developer&#8217;s guide for more.</p>
</div>
<div class="paragraph">
<p>In addition, CQL defines several structured types to facilitate representation and manipulation of clinical information:</p>
</div>
<table id="table-3-h" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Code</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents a clinical terminology code, including the code identifier, system, version, and display.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Concept</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents a single concept as a list of equivalent Codes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Quantity</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents a quantity with a dimension, specified in UCUM units.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Ratio</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Represents a ratio between two quantities</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑H - The structured types to facilitate representation and manipulation of clinical information</p>
</div>
<div class="paragraph">
<p>For more information about these types, refer to the <a href="09-b-cqlreference.html">CQL Reference</a> section on <a href="09-b-cqlreference.html#types-2">Types</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="specifying-types"><a class="anchor" href="#specifying-types"></a>4.2. Specifying Types</h3>
<div class="paragraph">
<p>In various constructs, the type of a value must be specified. For example, when defining the type of a parameter, or when testing a value to determine whether it is of a specific type. CQL provides the <em>type specifier</em> for this purpose. There are five categories of type-specifiers, corresponding to the four categories of values supported by CQL, plus a choice type category that allows for more flexible models and expressions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Named Types</p>
</li>
<li>
<p>Tuple Types</p>
</li>
<li>
<p>Interval Types</p>
</li>
<li>
<p>List Types</p>
</li>
<li>
<p>Choice Types</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A syntax diagram of the <em>type specifiers</em> in CQL can be seen <a href="19-l-cqlsyntaxdiagrams.html#typeSpecifier">here</a>.</p>
</div>
<div class="paragraph">
<p>The <em>named type specifier</em> is simply the name of the type. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">parameter Threshold Integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example declares a parameter named <span class="id">Threshold</span> of type <span class="id">Integer</span>.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of a <em>named type specifier</em> construct can be seen <a href="19-l-cqlsyntaxdiagrams.html#namedTypeSpecifier">here</a>.</p>
</div>
<div class="paragraph">
<p>The <em>tuple type specifier</em> allows the names and types of the elements of the type to be specified. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">parameter Demographics Tuple { address String, city String, zip String }</code></pre>
</div>
</div>
<div class="paragraph">
<p>A syntax diagram of a <em>tuple type specifier</em> construct can be seen <a href="19-l-cqlsyntaxdiagrams.html#tupleTypeSpecifier">here</a>.</p>
</div>
<div class="paragraph">
<p>The <em>interval type specifier</em> allows the point-type of the interval to be specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">parameter Range Interval&lt;Integer&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A syntax diagram of a <em>interval type specifier</em> construct can be seen <a href="19-l-cqlsyntaxdiagrams.html#intervalTypeSpecifier">here</a>.</p>
</div>
<div class="paragraph">
<p>The <em>list type specifier</em> allows the element-type of a list to be specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">parameter Points List&lt;Integer&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A syntax diagram of a <em>list type specifier</em> construct can be seen <a href="19-l-cqlsyntaxdiagrams.html#listTypeSpecifier">here</a>.</p>
</div>
<div class="paragraph">
<p>And finally, the <em>choice type specifier</em> allows a choice type to be specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">parameter ChoiceValue Choice&lt;Integer, String&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A syntax diagram of a <em>choice type specifier</em> construct can be seen <a href="19-l-cqlsyntaxdiagrams.html#choiceTypeSpecifier">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="type-testing"><a class="anchor" href="#type-testing"></a>4.3. Type Testing</h3>
<div class="paragraph">
<p>CQL supports the ability to test whether or not a value is of a given type. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">5 is Integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>returns <span class="kw">true</span> because <span class="lit">5</span> is an <span class="id">Integer</span>.</p>
</div>
<div class="paragraph">
<p>In general, the <em>is</em> relationship determines whether or not a given type is derived from another type. Given a type T and a type T' derived from type T, the following definitions hold:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Identity – T is T</p>
</li>
<li>
<p>Subtype – T' is T</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that because of the <em>identity</em> relationship above, the term <em>subtype</em> applies to all derived types, as well as the type itself. In the discussions that follow, if a definition must explicitly refer to only derived types, the term <em>proper subtype</em> will be used.</p>
</div>
<div class="paragraph">
<p>For interval types, given a point type P, and a point type P' derived from type P, interval type Interval&lt;P'&gt; is a subtype of interval type Interval&lt;P&gt;.</p>
</div>
<div class="paragraph">
<p>For list types, given an element type E, and an element type E' derived from type E, list type List&lt;E'&gt; is a subtype of list type List&lt;E&gt;.</p>
</div>
<div class="paragraph">
<p>For tuple types, given a tuple type T with elements E<sub>1</sub>, E<sub>2</sub>, &#8230;&#8203;E<sub>n</sub>, names N<sub>1</sub>, N<sub>2</sub>, &#8230;&#8203;N<sub>n</sub>­, and types T<sub>1</sub>, T<sub>2</sub>, &#8230;&#8203;T<sub>n</sub>, respectively, a tuple type T' with elements E'<sub>1</sub>, E'<sub>2</sub>, &#8230;&#8203;E'<sub>n</sub>, names N'<sub>1</sub>, N'<sub>2</sub>, &#8230;&#8203;N'<sub>n</sub>, and types T'<sub>1</sub>, T'<sub>2</sub>, &#8230;&#8203;T'<sub>n</sub>, type T' is a subtype of type T if and only if:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The number of elements in each type is the same: |E| = |E'|</p>
</li>
<li>
<p>For each element in T, there is one element in T' with the same name, and the type of the matching element in T' is a subtype of the type of the element in T.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For structured types, the supertype is specified as part of the definition of the type. Subtypes inherit all the elements of the supertype and may define additional elements that are only present on the derived type.</p>
</div>
</div>
<div class="sect2">
<h3 id="choice-types"><a class="anchor" href="#choice-types"></a>4.4. Choice Types</h3>
<div class="paragraph">
<p>CQL also supports the notion of a <em>choice type</em>, a type that is defined by a list of component types. For example, an element of a tuple type may be a choice of <span class="id">Integer</span> or <span class="id">String</span>, meaning that the element may contain a value that is either an <span class="id">Integer</span>, or a <span class="id">String</span>.</p>
</div>
<div class="paragraph">
<p>In addition, choice types can be used to indicate the type of a list of mixed elements, such as the result of a <span class="kw">union</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">[Procedure] union [Encounter]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example results in a list that contains both Procedures and Encounters, and the resulting type is <span class="id">Choice&lt;Procedure</span>, <span class="id">Encounter&gt;</span>.</p>
</div>
<div class="paragraph">
<p>An expression of a choice type can be used anywhere that a value of any of its component types is expected, and an implicit cast will be used to restrict the choice type to the correct component type.</p>
</div>
<div class="paragraph">
<p>For example, given an <span class="id">Observation</span> type with an element <span class="id">value</span> of type <span class="id">Choice&lt;String</span>, <span class="id">Code</span>, <span class="id">Integer</span>, <span class="id">Decimal</span>, <span class="id">Quantity&gt;</span>, the following expressions are all valid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Observation.value + 12
Observation.value &amp; ' (observed)' +
Observation.value in "Valid Values" +
Observation.value &lt; 5 'mg'</code></pre>
</div>
</div>
<div class="paragraph">
<p>These expressions will result in an implicit cast being applied as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">(Observation.value as Integer) + 12 +
(Observation.value as String) &amp; ' (observed)' +
(Observation.value as Code) in "Valid Values" +
(Observation.value as Quantity) &lt; 5 'mg'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The semantics for casting will result in a <span class="kw">null</span> if the run-time value of the element is not of the appropriate type.</p>
</div>
<div class="paragraph">
<p>When accessing an element of a choice type with structured types as components, any element can be accessed. Note, however, that if the element being accessed is present in multiple components, the resulting expression may be a choice type if the elements have different types.</p>
</div>
<div class="paragraph">
<p>In addition, the choice type enables the set operations, <span class="kw">union</span>, <span class="kw">intersect</span>, and <span class="kw">except</span> to be generalized to work on lists of different types.</p>
</div>
<div class="paragraph">
<p>For <span class="kw">union</span>, this means that the inputs can be lists of different types of elements, and the type of the result is now a choice type with components of each of the input types. If the input types are the same, the result is a choice with a single component which degenerates to the component type.</p>
</div>
<div class="paragraph">
<p>For <span class="kw">intersect</span>, this means the inputs can be lists of different types of elements, and the type of the result is a choice with only the types that are common between the input types. Again, if this results in a choice with a single component, it degenerates to the component type.</p>
</div>
<div class="paragraph">
<p>For <span class="kw">except</span>, this means that the inputs can contain lists of different types of elements, but because the except may not exclude all the values of a given type, the result will be the same type as the left input.</p>
</div>
</div>
<div class="sect2">
<h3 id="type-inference"><a class="anchor" href="#type-inference"></a>4.5. Type Inference</h3>
<div class="paragraph">
<p>Type inference is the process of determining the type of an expression based on the types of the values and operations involved in the expression. CQL is a strongly typed language, meaning that it is always possible to infer the type of an expression at compile-time (i.e. by static analysis).</p>
</div>
<div class="paragraph">
<p>The type inference rules for the various categories of language constructs are given in the following sections.</p>
</div>
<div class="sect3">
<h4 id="literals-and-selectors"><a class="anchor" href="#literals-and-selectors"></a>4.5.1. Literals and Selectors</h4>
<div class="paragraph">
<p>The type of a literal is trivial for the primitive types and selectors: <span class="id">Boolean</span>, <span class="id">String</span>, <span class="id">Integer</span>, <span class="id">Long</span>, <span class="id">Decimal</span>, <span class="id">Date</span>, <span class="id">DateTime</span>, <span class="id">Time</span>, <span class="id">Quantity</span>, and <span class="id">Ratio</span>.</p>
</div>
<div class="paragraph">
<p>The type of the null selector is Any.</p>
</div>
<div class="paragraph">
<p>For a list selector, the type may be specified as part of the selector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">List&lt;System.Integer&gt; { 1, 2, 3 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or it may be inferred based on the types of the elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">{ 1, 2, 3 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>For an empty list, with no specifier, the type is List&lt;Any&gt;.</p>
</div>
<div class="paragraph">
<p>If the type of a list is specified, the elements in the list are required to be of the declared element type of the list.</p>
</div>
<div class="paragraph">
<p>If the type of the list is inferred, the type of the first element is used initially, and subsequent elements in the list are required to be of the inferred type of the first element, with the exception that if a subsequent element is a supertype of the initial element, or if the initial element is convertible to the type of a subsequent element, the type of the subsequent element will become the new inferred element type for the list.</p>
</div>
<div class="paragraph">
<p>For a tuple selector, the type is constructed from the elements in the tuple selector.</p>
</div>
<div class="paragraph">
<p>For an instance selector, the type is determined by the name of the type of the instance being constructed.</p>
</div>
</div>
<div class="sect3">
<h4 id="operators-and-functions"><a class="anchor" href="#operators-and-functions"></a>4.5.2. Operators and Functions</h4>
<div class="paragraph">
<p>In general, the result type of an operator or function is determined by the declared return type of the function. For example, the (Integer, Integer) overload of the Add operator returns an Integer value, so the type of an Add invocation is Integer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">3 + 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>The CQL Reference appendix gives the signatures and declared return types for all system operators.</p>
</div>
<div class="paragraph">
<p>In addition to special cases for operators such as conditionals and Coalesce, CQL defines implicit conversion, casting, and promotion and demotion to provide more flexible type checking rules. These special cases are described in subsequent sections.</p>
</div>
</div>
<div class="sect3">
<h4 id="queries-1"><a class="anchor" href="#queries-1"></a>4.5.3. Queries</h4>
<div class="paragraph">
<p>For queries, the type inference rules are based on the clauses used, beginning with single-source queries:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For a single-source query, the initial type of the query is the type of expression defining the single source. If the expression is singular (i.e. non-list-valued) the query ranges over only that element. If the expression is plural, the query ranges over all the elements in the list.</p>
</li>
<li>
<p>For a multi-source query, the initial type of the query is defined by a tuple where each tuple has an element for each source in the query, named the alias name of the source, and of the type of the expression defining the source. If all sources are singular the initial type of the query is the singular tuple type. If any source is plural, the initial type of the query is a list of the tuple type.</p>
</li>
<li>
<p>Let clauses only introduce content that can be referenced within the scope of the query, they do not impact the type of the result unless referenced within a return clause.</p>
</li>
<li>
<p>With and without clauses only limit the set of results returned by a query, they do not impact the type of the result.</p>
</li>
<li>
<p>A where clause only limits the set of results returned by the query, it does not impact the type of the result.</p>
</li>
<li>
<p>The return clause determines the overall shape of the query result. If there is no return clause, the result type of the query is the same as the initial type of the query as determined based on the sources. If a return clause is used, the result type of the query is inferred based on the return expression. If the query is singular, the result type is the type of the return clause expression. If the query is plural, the result type is a list whose element types are the type of the return expression.</p>
</li>
<li>
<p>Similar to the return clause, an aggregate clause, if present, determines the overall result of the query. If an aggregate clause is used, the result type of the query is the result type of the aggregate expression, regardless of whether the query is singular or plural.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="conversion"><a class="anchor" href="#conversion"></a>4.6. Conversion</h3>
<div class="paragraph">
<p>Conversion is the operation of turning a value from one type into another. For example, converting a number to a string, or vice-versa. CQL supports explicit conversion operators, as well as implicit conversion for some specific types.</p>
</div>
<div class="sect3">
<h4 id="explicit-conversion"><a class="anchor" href="#explicit-conversion"></a>4.6.1. Explicit Conversion</h4>
<div class="paragraph">
<p>The explicit <span class="kw">convert</span> can be used to convert a value from one type to another. For example, to convert the string representation of a datetime to a <span class="id">DateTime</span> value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">convert '2014-01-01T12:00:00.0-06:00' to DateTime</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the conversion cannot be performed, the result is <span class="kw">null</span>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">convert 'Foo' to Integer</code></pre>
</div>
</div>
<div class="paragraph">
<p>will result in <span class="kw">null</span>. The convert syntax is equivalent to invoking one of the defined conversion operators:</p>
</div>
<table id="table-3-i" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;"/>
<col style="width: 50%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToBoolean(Decimal)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the decimal representation of a boolean value (<code>0.0</code> or <code>1.0</code>) to a Boolean value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToBoolean(Integer)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the integer representation of a boolean value (<code>0</code> or <code>1</code>) to a Boolean value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToBoolean(Long)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the long representation of a boolean value (<code>0L</code> or <code>1L</code>) to a Boolean value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToBoolean(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a boolean value to a Boolean value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToInteger(Boolean)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a boolean to an integer value, true results in <code>1</code>, false results in <code>0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToInteger(Long)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Long value to an equivalent Integer value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToInteger(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of an integer value to an Integer value using the format (<span class="sym">+|-</span>)d*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToLong(Boolean)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a boolean value to an equivalent Long value, true results in <code>1L</code>, false results in <code>0L</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToLong(Integer)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts an Integer value to an equivalent Long value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToLong(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a long value to a Long value using the format (<span class="sym">+|-</span>)d*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDecimal(Boolean)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Boolean value to an equivalent Decimal value, true results in <code>1.0</code>, false results in <code>0.0</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDecimal(Integer)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts an Integer value to an equivalent Decimal value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDecimal(Long)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Long value to an equivalent Decimal value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDecimal(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a decimal value to a Decimal value using the format (<span class="sym">+|-</span>)d*.d*</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToQuantity(Decimal)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Decimal value to a Quantity with a default unit ('1')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToQuantity(Integer)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts an Integer value to a Quantity with a default unit ('1')</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToQuantity(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a quantity value to a Quantity value using the format (<span class="sym">+|-</span>)d*.d*'units'</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToRatio(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a ratio value to a Ratio value using the format &lt;quantity&gt;:&lt;quantity&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDate(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a date value to a Date value using ISO-8601 format: YYYY-MM-DD</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDate(DateTime)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a DateTime to a Date. This is equivalent to invoking <span class="kw">date from</span> on the DateTime value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDateTime(Date)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Date value to a DateTime with all time components unspecified and the timezone offset of the request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToDateTime(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a datetime value to a DateTime value using ISO-8601 format: YYYY-MM-DDThh:mm:ss.fff(+|-)hh:mm</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToTime(String)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts the string representation of a time value to a Time value using ISO-8601 format: hh:mm:ss.fff</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Boolean)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Boolean value to its string representation (true|false)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Integer)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts an Integer value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Long)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Long value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Decimal)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Decimal value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Quantity)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Quantity value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Ratio)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Ratio value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Date)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Date value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(DateTime)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a DateTime value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToString(Time)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Time value to its string representation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToConcept(Code)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a Code value to a Concept with the given Code as its primary and only Code. If the Code has a display value, the Concept will have the same display value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ToConcept(List&lt;Code&gt;)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a list of Code values to a Concept with the first Code in the list as the primary Code. If the primary Code has a display value, the Concept will have the same display value.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑I - The defined type conversion operators in CQL</p>
</div>
<div class="paragraph">
<p>For a complete description of these conversion operators, refer to the <a href="09-b-cqlreference.html#type-operators-1">Type Operators</a> section in the <a href="09-b-cqlreference.html">CQL Reference</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="quantity-conversions"><a class="anchor" href="#quantity-conversions"></a>4.6.2. Quantity Conversions</h4>
<div class="paragraph">
<p>In addition to type conversions, CQL supports <em>quantity conversion</em>, converting a quantity from one unit to another unit using the same <span class="kw">convert</span> keyword:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">convert 5000 'g' to 'kg'
convert 28 days to weeks</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the unit conversion is valid, the expression results in a quantity with the target units. If the unit conversion is invalid, the result is <span class="kw">null</span>.</p>
</div>
<div class="quoteblock note-warning">
<blockquote>
<div class="paragraph">
<p>Note that implementations are not required to support quantity conversion. Implementations that do support unit conversion shall do so according to the conversion specified by UCUM. Implementations that do not support unit conversion shall throw an error if an unsupported unit conversion is requested with this operation.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect3">
<h4 id="implicit-conversions"><a class="anchor" href="#implicit-conversions"></a>4.6.3. Implicit Conversions</h4>
<div class="paragraph">
<p>In addition to the explicit conversion operators discussed above, CQL supports implicit conversions for specific types to enable expressions to be built more easily. The following table lists the explicit and implicit conversions supported in CQL:</p>
</div>
<table id="table-3-j" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1428%;"/>
<col style="width: 7.1436%;"/>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">From\To</th>
<th class="tableblock halign-left valign-top">Boolean</th>
<th class="tableblock halign-left valign-top">Integer</th>
<th class="tableblock halign-left valign-top">Long</th>
<th class="tableblock halign-left valign-top">Decimal</th>
<th class="tableblock halign-left valign-top">Quantity</th>
<th class="tableblock halign-left valign-top">Ratio</th>
<th class="tableblock halign-left valign-top">String</th>
<th class="tableblock halign-left valign-top">Date</th>
<th class="tableblock halign-left valign-top">DateTime</th>
<th class="tableblock halign-left valign-top">Time</th>
<th class="tableblock halign-left valign-top">Code</th>
<th class="tableblock halign-left valign-top">Concept</th>
<th class="tableblock halign-left valign-top">List&lt;Code&gt;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ValueSet</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Boolean</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Integer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Long</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Decimal</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Quantity</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Ratio</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>String</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Date</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>DateTime</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Time</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Code</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Concept</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>List&lt;Code&gt;</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Explicit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ValueSet</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Implicit</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Table 3‑J - The explicit and implicit conversions supported in CQL</p>
</div>
<div class="paragraph">
<p>In addition to these conversions, note that specific data models may introduce conversions, including implicit conversions.</p>
</div>
<div class="paragraph">
<p>Although implicit conversions can be performed using the explicit convert, the language will also automatically apply implicit conversions when appropriate to produce a correctly typed expression. For example, consider the following multiplication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "MixedMultiply": 1 * 1.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of the literal <span class="lit">1</span> is <span class="id">Integer</span>, and the type of the literal <span class="lit">1.0</span> is <span class="id">Decimal</span>. To infer the type of the expression correctly, the language will implicitly convert the type of the <span class="lit">1</span> to <span class="id">Decimal</span> by inserting a <span class="id">ToDecimal</span> invocation. The multiplication is then performed on two <span class="id">Decimals</span>, and the result type is <span class="id">Decimal</span>.</p>
</div>
<div class="paragraph">
<p>In addition, CQL defines implicit conversion of a named structured type to its equivalent tuple type. For example, given the type <span class="id">Person</span> with elements <span class="id">Name</span> of type <span class="id">String</span> and <span class="id">DOB</span> of type <span class="id">DateTime</span>, the following comparison is valid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "TupleComparison": Person { Name: 'Joe', DOB: @1970-01-01 } = Tuple { Name: 'Joe', DOB: @1970-01-01 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the structured value will be implicitly converted to the equivalent tuple type, and the comparison will evaluate to true.</p>
</div>
<div class="paragraph">
<p>Note that the opposite implicit conversion, from a tuple to a named structured type, does not occur because a named structured type has additional information (namely the type hierarchy) that cannot be inferred from the definition of a tuple type. In such cases, an explicit conversion can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "TupleExpression": Tuple { Name: 'Joe', DOB: @1970-01-01 }
define "TupleConvert": convert TupleExpression to Person</code></pre>
</div>
</div>
<div class="paragraph">
<p>The conversion from a tuple to a structured type requires that the set of elements in the tuple type be the same set or a subset of the elements in the structured type.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="casting"><a class="anchor" href="#casting"></a>4.7. Casting</h3>
<div class="paragraph">
<p>Casting is the operation of treating a value of some base type as a more specific type at run-time. The <span class="kw">as</span> operator provides this functionality. For example, given a model that defines an <span class="id">ImagingProcedure</span> as a specialization of a <span class="id">Procedure</span>, in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "AllProcedures": [Procedure]
define "ImagingProcedures":
  AllProcedures P
    where P is ImagingProcedure
    return P as ImagingProcedure</code></pre>
</div>
</div>
<div class="paragraph">
<p>the <span class="id">ImagingProcedures</span> expression returns all procedures that are instances of <span class="id">ImagingProcedure</span> as instances of <span class="id">ImagingProcedure</span>. This means that attributes that are specific to <span class="id">ImagingProcedure</span> can be accessed.</p>
</div>
<div class="paragraph">
<p>If the run-time type of the value is not of the type specified in the <span class="kw">as</span> operator, the result is <span class="kw">null</span>.</p>
</div>
<div class="paragraph">
<p>In addition, CQL supports a <em>strict</em> cast, which has the same semantics as casting, except that if the run-time type of the value is not of the type specified, a run-time error is thrown. The keyword <span class="kw">cast</span> is used to indicate a strict cast:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "StrictCast": cast First(Procedures) as ImagingProcedure</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="implicit-casting"><a class="anchor" href="#implicit-casting"></a>4.7.1. Implicit Casting</h4>
<div class="paragraph">
<p>CQL also supports the notion of <em>implicit casting</em> to prevent the need to cast a <span class="kw">null</span> literal to a specific type. For example, consider the following expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "ImplicitCast": 5 * null</code></pre>
</div>
</div>
<div class="paragraph">
<p>The type of the first argument to the multiplication is <span class="id">Integer</span>, and the type of the second argument is <span class="id">Any</span>, an untyped <span class="kw">null</span> literal. But multipication of <span class="id">Integer</span> and <span class="id">Any</span> is not defined and <span class="id">Any</span> is a supertype of <span class="id">Integer</span>, not a subtype. This means that with strict typing, this expression would not compile without the addition of an explicit cast:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "ImplicitCast": 5 * (null as Integer)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To avoid the need for this explicit cast, CQL implicitly casts the <span class="id">Any</span> to <span class="id">Integer</span>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="promotion-and-demotion"><a class="anchor" href="#promotion-and-demotion"></a>4.8. Promotion and Demotion</h3>
<div class="paragraph">
<p>To simplify the expression of logic involving lists and intervals, CQL defines <em>promotion</em> and <em>demotion</em>, which are a special class of implicit conversions.</p>
</div>
<div class="paragraph">
<p>Promotion is used to implicitly convert a value to a list of values of that type. Whenever an operation that expects a list-valued argument is passed a single value, the single value may be promoted to a list of the same type containing the single value as its only element.</p>
</div>
<div class="paragraph">
<p>Demotion is the opposite, used to implicitly extract a single value from a list of values. Whenever an operation that expects a singleton is passed a list, the list may be demoted to a singleton using <span class="kw">singleton from</span>.</p>
</div>
<div class="paragraph">
<p>For intervals, promotion is performed by creating an interval with the single value as the start and end of the interval, and demotion is performed using <span class="kw">point from</span>.</p>
</div>
<div class="paragraph">
<p>Note that the use of demotion has the potential to result in a run-time error if <span class="kw">singleton from</span> is invoked on a list with multiple elements, or if <span class="kw">point from</span> is invoked on an interval wider than a single point. In addition, promotion and demotion can sometimes result in unexpected behavior. As such, environments may choose whether or not to support these features of the language.</p>
</div>
<div class="paragraph">
<p>Whether or not promotion and demotion should be used depends on the type-safety expectations for each use case. As such, promotion and demotion should only be used in environments where the consequences are well understood. By default, list promotion and demotion are appropriate to support the use of FHIRPath, interval promotion is used only to enable mixed-type signatures for the <span class="kw">same or after</span> and <span class="kw">same or before</span> operators, and interval demotion is not used.</p>
</div>
</div>
<div class="sect2">
<h3 id="conversion-precedence"><a class="anchor" href="#conversion-precedence"></a>4.9. Conversion Precedence</h3>
<div class="paragraph">
<p>Because of the possibility that a given invocation signature may be resolved to multiple overloads of an operator through the application of different conversions, CQL specifies a conversion precedence for resolving the ambiguity. When matching the invocation type of an argument to the declared type of the corresponding argument of an operator, the following precedence is applied:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Exact match – If the invocation type is an exact match to the declared type of the argument</p>
</li>
<li>
<p>Subtype – If the invocation type is a subtype of the declared type of the argument</p>
</li>
<li>
<p>Compatible – If the invocation type is compatible with the declared type of the argument (e.g., the invocation type is Any)</p>
</li>
<li>
<p>Cast - If the invocation type can be cast to the declare type (e.g., the invocation type is a choice that includes the declared type)</p>
</li>
<li>
<p>Implicit Conversion To Simple Type – An implicit conversion is defined from the invocation type of the argument to the declared type of the argument, and the declared type is a simple type</p>
</li>
<li>
<p>Implicit Conversion To Class Type - An implicit conversion is defined from the invocation type of the argument to the declared type of the argument, and the declared type is a class type</p>
</li>
<li>
<p>Interval Promotion - The declared type is an interval and the invocation type can be promoted to an interval of that type</p>
</li>
<li>
<p>List Demotion – The invocation type of the argument is a list and can be demoted to the declared type</p>
</li>
<li>
<p>Interval Demotion - The invocation type of the argument is an interval and can be demoted to the declared type</p>
</li>
<li>
<p>List Promotion – The declared type is a list and the invocation type can be promoted to a list of that type</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>These conversion precedences can be viewed as ordered from <em>least converting</em> to <em>most converting</em>. When determining a conversion path from an invocation signature to a declared signature, the <em>least converting</em> overall conversion path is used.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conditional-expressions"><a class="anchor" href="#conditional-expressions"></a>5. Conditional Expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To simplify the expression of complex logic, CQL provides two flavors of conditional expressions, the <span class="kw">if</span> expression, and the <span class="kw">case</span> expression.</p>
</div>
<div class="paragraph">
<p>The if expression allows a single condition to select between two expressions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">if Count(X) &gt; 0 then X[1] else 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>This expression checks the count of X and returns the first element if it is greater than <span class="lit">0</span>; otherwise, the expression returns <span class="lit">0</span>. Note that if the condition evaluates to <span class="kw">null</span>, it is interpreted as <span class="kw">false</span>.</p>
</div>
<div class="paragraph">
<p>The <span class="kw">case</span> expression allows multiple conditions to be tested, and comes in two flavors: standard case, and selected case.</p>
</div>
<div class="paragraph">
<p>A standard case allows any number of conditions, each with a corresponding expression that will be the result of the <span class="kw">case</span> if the associated condition evaluates to <span class="kw">true</span>. Note that as with the if expression, if the condition evaluates to <span class="kw">null</span>, it is interpreted as <span class="kw">false</span>. If none of the conditions evaluate to <span class="kw">true</span>, the <span class="kw">else</span> expression is the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">case
  when X &gt; Y then X
  when Y &gt; X then Y
  else 0
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>A selected case specifies a comparand, and each case item specifies a possible value for the comparand. If the comparand is equal to a case item, the corresponding expression is the result of the selected case. If the comparand does not equal any of the case items, the else expression is the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">case X
  when 1 then 12
  when 2 then 14
  else 15
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that if the source expression in a selected case is <span class="kw">null</span>, no condition will compare equal and the result will be the else expression. If any case item is <span class="kw">null</span>, it will not compare equal to the comparand.</p>
</div>
<div class="paragraph">
<p>Both of these conditional expression constructs require run-time conditional evaluation. This is sometimes referred to as short-circuit evaluation for conditional expressions. For implementations, this means delaying evaluation of the arguments. Revisiting the first example in this section:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">if Count(X) &gt; 0 then X[1] else 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Short-circuit evaluation means the expression <code>X[1]</code> will only be evaluated if <code>Count(X) &gt; 0</code> evaluates to <span class="kw">true</span>. This is in contrast to the logical operators <span class="kw">and</span> and <span class="kw">or</span>, where short-circuit evaluation is not required.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="nullological-operators"><a class="anchor" href="#nullological-operators"></a>6. Nullological Operators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To provide complete support for missing information, CQL supports several operators for testing for and dealing with null results.</p>
</div>
<div class="paragraph">
<p>To provide a null result, use the <span class="kw">null</span> keyword:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">null</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test whether an expression is <span class="kw">null</span>, use the <em>null test</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">X is null
X is not null</code></pre>
</div>
</div>
<div class="paragraph">
<p>To replace a null with the result of an expression, use a simple <span class="kw">if</span> expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">if X is null then Y else X</code></pre>
</div>
</div>
<div class="paragraph">
<p>To return the first non-null expression among two or more expressions, use the <span class="id">Coalesce</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Coalesce(X, Y, Z)</code></pre>
</div>
</div>
<div class="paragraph">
<p>which is equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">case
  when X is not null then X
  when Y is not null then Y
  else Z
end</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition, CQL supports the boolean-test operators <span class="kw">is [not] true</span> and <span class="kw">is [not] false</span>. These operators, like the null-test operator, only return <span class="kw">true</span> and <span class="kw">false</span>, they will not propagate a <span class="kw">null</span> result.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">X is true
X is not false</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first example will return <span class="kw">true</span> if X evaluates to <span class="kw">true</span>, <span class="kw">false</span> if X evaluates to <span class="kw">false</span> or <span class="kw">null</span>. The second example will return <span class="kw">true</span> if X evaluates to <span class="kw">true</span> or <span class="kw">null</span>, <span class="kw">false</span> if X evaluates to <span class="kw">false</span>. Note in particular that these operators are <em>not</em> equivalent to comparison of <span class="id">Boolean</span> results using equality or inequality.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="string-operators"><a class="anchor" href="#string-operators"></a>7. String Operators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Although less common in typical clinical logic, some use cases require string manipulation. As such, CQL supports a core set of string operators.</p>
</div>
<div class="paragraph">
<p>Like lists, strings are 0-based in CQL. To index into a string, use the <em>indexer</em> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">X[0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>To determine the length of string, use the <span class="id">Length</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Length(X)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To determine the position of a given pattern within a string, use the <span class="id">PositionOf</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">PositionOf('cde', 'abcdefg')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <span class="id">PositionOf()</span> operator returns the index of the starting character of the first argument in the second argument, if the first argument can be located in the second argument. Otherwise, <span class="id">PositionOf()</span> returns <span class="lit">-1</span> to indicate the pattern was not found in the string. To find the last appearance of a given pattern, use <span class="id">LastPositionOf()</span>, and to find patterns at the beginning and end of a string, use <span class="id">StartsWith()</span> and <span class="id">EndsWith()</span>. Regular expression matching can be performed with the <span class="id">Matches()</span> and <span class="id">ReplaceMatches()</span> operators.</p>
</div>
<div class="paragraph">
<p>To return a substring from a given string, use the <span class="id">Substring</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Substring('abcdefg', 0, 3)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example returns the string <span class="lit">'abc'</span>. The second argument is the starting index of the substring to be returned, and the third argument is the length of the substring to be returned. If the length is greater than the number of characters present in the string from the starting index on, the result includes only the remaining characters. If the starting index is less than 0, or greater than the length of the string, the result is <span class="kw">null</span>. The third argument is optional; if it is not provided, the substring is taken from the starting index to the end of the string.</p>
</div>
<div class="paragraph">
<p>To concatenate strings, use the <span class="sym">+</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">'abc' + 'defg'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that when using <span class="sym">+</span> with string values, if either argument is <span class="kw">null</span>, the result will be <span class="kw">null</span>. To treat <span class="kw">null</span> as the empty string (<span class="sym">''</span>), use the <span class="sym">&amp;</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">'abc' &amp; 'defg'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To combine a list of strings, use the <span class="id">Combine</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Combine({ 'ab', 'cd', 'ef' })</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of this expression is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">'abcdef'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To combine a list with a separator, provide the separator argument to the <span class="id">Combine</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Combine({ 'completed', 'refused', 'pending' }, ';')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of this expression is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">'completed;refused;pending'</code></pre>
</div>
</div>
<div class="paragraph">
<p>To split a string into a list of strings based on a specific separator, use the <span class="id">Split</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Split('completed;refused;pending', ';')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of this expression is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">{ 'completed', 'refused', 'pending' }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <span class="id">Upper</span> and <span class="id">Lower</span> operators to return strings with upper or lowercase letters for all characters in the argument.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introducing-context-in-queries"><a class="anchor" href="#introducing-context-in-queries"></a>8. Introducing Scoped Definitions in Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The CQL query construct provides for the ability to introduce named expressions that only exist within the scope of a single query. The <em>let clause</em> of queries allows any number of definitions to be provided. Each definition has access to all the available components of the query scope. This feature is extremely useful for simplifying query logic by allowing complex expressions to be defined and then reused within the scope of a single query. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">"Medications" M
  let ingredients: GetIngredients(M.rxNormCode)
  return
    ingredients I
      let
        adjustedDoseQuantity: EnsureMicrogramQuantity(M.doseQuantity),
        dailyDose:
          GetDailyDose(
            I.ingredientCode,
            I.strength,
            I.doseFormCode,
            adjustedDoseQuantity,
            M.dosesPerDay
          ),
        factor: GetConversionFactor(I.ingredientCode, dailyDose, I.doseFormCode)
      return {
        rxNormCode: M.rxNormCode,
        doseFormCode: I.doseFormCode,
        doseQuantity: adjustedDoseQuantity,
        dosesPerDay: M.dosesPerDay,
        ingredientCode: I.ingredientCode,
        ingredientName: I.ingredientName,
        strength: I.strength,
        dailyDose: dailyDose,
        mme: Quantity { value: dailyDose.value * factor, unit: dailyDose.unit + '/d' }
      }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this query, the same logic defined by the <span class="id">dailyDose</span> expression can be reused multiple times in the where clause, avoiding the need to repeat the calculation and making the intended meaning of the logic much more clear.</p>
</div>
<div class="paragraph">
<p>Note also the ability to reference a previously defined let in the same scope, as in the use of <span class="id">adjustedDoseQuantity</span> in the definition of <span class="id">dailyDose</span>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multi-source-queries"><a class="anchor" href="#multi-source-queries"></a>9. Multi-Source Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the single-source queries discussed in the Author’s Guide, CQL provides multi-source queries to allow for the simple expression of complex relationships between sets of data. Consider the following excerpt from the numerator of a measure for appropriate warfarin and parenteral anticoagulation overlap therapy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Numerator =</strong></p>
<div class="ulist">
<ul>
<li>
<p>Patients who received warfarin and parenteral anticoagulation:</p>
<div class="ulist">
<ul>
<li>
<p>Five or more days, with an INR greater than or equal to 2 prior to discontinuation of parenteral therapy</p>
</li>
<li>
<p>OR: Five or more days, with an INR less than 2 and discharged on overlap therapy</p>
</li>
<li>
<p>OR: Less than five days and discharged on overlap therapy</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>We begin by breaking this down into the source components, Encounters, Warfarin Therapy, and Parenteral Therapy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Encounters": [Encounter: "Inpatient"] E
  where E.period during "Measurement Period"
define "Warfarin Therapy": [MedicationAdministration: "Warfarin"]
define "Parenteral Therapy": [MedicationAdministration: "Parenteral Anticoagulation"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>First, we establish that the encounter had both warfarin and parenteral anticoagulation therapies. This is easy enough to accomplish using <span class="kw">with</span> clauses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Encounters with Warfarin and Parenteral Therapies":
  "Encounters" E
    with "Warfarin Therapy" W such that W.effectiveTime starts during E.period
    with "Parenteral Therapy" P such that P.effectiveTime starts during E.period</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the next step involves calculating the duration of overlap between the warfarin and parenteral therapies, and a with clause only filters by a relationship, it does not introduce any data from the related source. To allow queries like this to be easily expressed, CQL allows a <span class="kw">from</span> clause to be used to start a query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Encounters with Warfarin and Parenteral Therapies":
  from "Encounters" E,
    "Warfarin Therapy" W,
    "Parenteral Therapy" P
  where W.effectiveTime starts during E.period
    and P.effectiveTime starts during E.period</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now have both the encounter and the warfarin and parenteral therapies in scope and can perform calculations involving all three:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Encounters with overlapping Warfarin and Parenteral Therapies":
  from "Encounters" E,
    "Warfarin Therapy" W,
    "Parenteral Therapy" P
  where W.effectiveTime starts during E.period
    and P.effectiveTime starts during E.period
    and duration in days of (W.effectiveTime intersect P.effectiveTime) &gt;= 5
    and Last([Observation: "INR Value"] I
      where I.applies during P.effectiveTime sort by applies).value &gt;= 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us the first condition, namely that a patient was on overlapping warfarin and parenteral therapies for at least 5 days, and the ending INR result associated with the parenteral therapy is greater than or equal to 2.</p>
</div>
<div class="paragraph">
<p>Next, we need to build criteria for the other cases, but these cases involve the same calculations, just compared against different values, or in different ways. Rather than having to restate the calculations multiple times, CQL allows a <span class="kw">let</span> clause to be used to introduce an intermediate computational result within a query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Encounters with overlapping Warfarin and Parenteral Therapies":
  from "Encounters" E,
    "Warfarin Therapy" W,
    "Parenteral Therapy" P
  let
    overlapDuration: duration in days of (W.effectiveTime intersect P.effectiveTime),
    endingINR:
      Last([Observation: "INR Value"] I
        where I.applies during P.effectiveTime sort by applies
      ).value
  where W.effectiveTime starts during E.period
    and P.effectiveTime starts during E.period
    and (
      (overlapDuration &gt;= 5 and endingINR &gt;= 2)
      or (overlapDuration &gt;= 5 and endingINR &lt; 2
        and P.effectiveTime overlaps after E.period)
      or (overlapDuration &lt; 5
        and P.effectiveTime overlaps after E.period)
    )
return E</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the return clause in a query is optional, the type of the result of multi-source queries with no return clause is defined as a list of tuples with an element for each source named the alias for the source within the query and of the type of the elements of the source. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">from [Encounter] E, [MedicationStatement] M</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result type of this query is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">List&lt;Tuple { E Encounter, M MedicationStatement }&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result will be a list of tuples containing the cartesian product of all Encounters and Medication Statements.</p>
</div>
<div class="paragraph">
<p>In addition, the default for return clauses is <span class="kw">distinct</span>, as opposed to <span class="kw">all</span>, so if no return clause is specified, duplicates will be eliminated from the result.</p>
</div>
<div class="sect2">
<h3 id="query-syntax-options"><a class="anchor" href="#query-syntax-options"></a>9.1. Query Syntax Options</h3>
<div class="paragraph">
<p>Note that the grammar for CQL queries allows for the <span class="kw">from</span> keyword to be used for single- and multi-source queries. For example, the following is valid CQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">from [Encounter] E
  where E.effectiveTime starts after Today() - 1 year</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, parsing the grammar can be simplified by requiring that all queries start with the <span class="kw">from</span> keyword. To support a change to the language to enable this simplification, environments may require that all queries begin with the <span class="kw">from</span> keyword.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="non-retrieve-queries"><a class="anchor" href="#non-retrieve-queries"></a>10. Non-Retrieve Queries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In addition to the query examples already discussed, it is possible to use any arbitrary expression as the source for a query. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">({ 1, 2, 3, 4, 5 }) L return L * 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query results in <span class="sym">{</span> <span class="lit">2</span>, <span class="lit">4</span>, <span class="lit">6</span>, <span class="lit">8</span>, <span class="lit">10</span> <span class="sym">}</span>. Note that the parentheses are required for arbitrary expressions. A query source is either a retrieve, a qualified identifier, or a parenthesized expression.</p>
</div>
<div class="paragraph">
<p>The above example also illustrates that queries need not be based on lists of tuples. In fact, they need not be based on lists at all. The following example illustrates the use of a query to redefine a single tuple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "FirstInpatientEncounter":
  First([Encounter] E where E.class = 'inpatient' sort by period.start desc)

define "RedefinedEncounter":
  FirstInpatientEncounter E
    return Tuple {
      type: E.type,
      admissionDate: E.period.start,
      dischargeDate: E.period.end
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition, even if a given query is based on a list of tuples, the results are not required to be tuples. For example, if only the length of stay is required, the following example could be used to return a list of integers representing the length of stay in days for each encounter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">[Encounter: "Inpatient"] E
  return duration in days of E.period</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="related-context-retrieves"><a class="anchor" href="#related-context-retrieves"></a>11. Related Context Retrieves</h2>
<div class="sectionbody">
<div class="quoteblock note-info">
<blockquote>
<div class="paragraph">
<p>Support for specifying search paths, include and reverseInclude elements in the Retrieve is a new feature of CQL 1.5, and is trial-use.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>To allow queries to cross contexts, CQL supports the notion of a <em>related context retrieve</em>. For example, consider a neonatal measure where the infant is the subject of the measure. In order to calculate gestational age, the measure may need to retrieve information from the mother&#8217;s record. Without the ability to cross contexts, this would not be possible. The following example illustrates this usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">context Patient

define "Mother": singleton from ([RelatedPerson: "Mother Relationship"])

define "Estimated Due Date":
  Last(
    ["Mother" -&gt; "Observation": "Estimated Due Date Exam"] Exam
      sort by effective
  )

define "Gestational Age in Days at Birth":
  (280 - (duration in days between "Estimated Due Date" and "Birth Date")) div 7</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of the <span class="id">"Mother"</span> expression within the retrieve: <span class="id">["Mother" -&gt; "Observation": "Estimated Due Date Exam"]</span>. This syntax (<span class="sym">-&gt;</span>) indicates that the retrieve should be performed in the context returned by the <span class="id">"Mother"</span> expression. The <span class="id">"Mother"</span> expression in this case will be evaluated in the <span class="id">"Patient"</span> context, and result in a <span class="id">RelatedPerson</span> from the infant&#8217;s record with the relationship type of <span class="id">"Mother Relationship"</span>. The <span class="id">RelatedPerson</span> will then be used as the context for the retrieve.</p>
</div>
<div class="paragraph">
<p>If the expression being defined (such as "Mother" in the previous example) is <span class="kw">null</span>, the related context retrieve would be evaluated with <span class="id">id</span> <span class="sym">= null</span>, which would result in unknown and an empty list would be the result. If the expression returns a class instance (as in this case, an instance of a <span class="id">RelatedPerson</span>), the model information is used to determine the attribute of the class that contains the value for the context id (<span class="id">linkedPatientId</span> in this case). And finally, the expression is not allowed to return a list, it must evaluate to a single class or primitive value.</p>
</div>
<div class="quoteblock note-danger">
<blockquote>
<div class="paragraph">
<p>As with all healthcare-related data, there are privacy and security concerns associated with this feature. Implementations must ensure that use of this functionality does not violate any access, authorization, or use protocols in the systems being accessed with this feature.</p>
</div>
<div class="paragraph">
<p>See the <a href="examples.html#mother-infant-measure">Mother Infant Measure</a> example for a detailed illustration of this functionality.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="aggregate-queries"><a class="anchor" href="#aggregate-queries"></a>12. Aggregate Queries</h2>
<div class="sectionbody">
<div class="quoteblock note-info">
<blockquote>
<div class="paragraph">
<p>The aggregate clause is a new feature of CQL 1.5, and is trial-use.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>CQL provides support for a limited class of recursive problems using the <em>aggregate clause</em> of the query construct. This clause is similar in function to the JavaScript <code>.reduce()</code> function, in that it allows an expression to be repeatedly evaluated for each element of a list, and that expression can access the <em>current</em> value of the aggregation. For example, the following query illustrates a simple usage of this construct to calculate the factorial of 5:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define FactorialOfFive:
  ({ 1, 2, 3, 4, 5 }) Num
    aggregate Result starting 1: Result * Num</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the list of integers from <code>1</code> to <code>5</code> is introduced as the primary source in a query with the alias <code>Num</code>, and then the <code>aggregate</code> clause is used to calculate the factorial. The result is named <code>Result</code> and given the starting value of <code>1</code>. This result is then repeatedly multiplied by each integer in the list to produce the final result.</p>
</div>
<div class="paragraph">
<p>More formally, the <code>aggregate</code> clause has the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ebnf" data-lang="ebnf">&lt;aggregate clause&gt; ::=
  aggregate [(all | distinct)] &lt;result alias&gt; [&lt;starting clause&gt;] : &lt;expression&gt;

&lt;starting clause&gt; ::=
  starting (&lt;simple literal&gt; | &lt;quantity | "("&lt;expression&gt;")")</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>aggregate</code> clause may be used in any query instead of a <code>return</code> clause, and causes the query to return the result of the last iteration of the aggregate expression. The <code>all</code> and <code>distinct</code> keywords can be used and apply to the elements prior to the iteration. The <code>result alias</code> is an identifier that can be used within the aggregation expression to refer to the current result value, enabling a limited form of recursion. The <code>starting clause</code> can be used to provide an initial value for the aggregation. If no starting clause is specified, the aggregation result is initially <code>null</code>.</p>
</div>
<div class="paragraph">
<p>As in the simple example above, the result of the query can be a single value, rather than a list of values, but note that since the aggregate expression may return a list, the result of an <code>aggregate</code> query may still be a list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "RolledOutIntervals":
  MedicationRequestIntervals M
    aggregate R starting (null as List&lt;Interval&lt;DateTime&gt;&gt;): R union ({
      M X
        let S: Max({ end of Last(R) + 1 day, start of X }),
          E: S + duration in days of X
        return Interval[S, E]
    })</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>aggregate</code> expression is returning the union of the current result with an interval constructed from the greater of the day after the end of the last interval and the start of the current interval, to the duration in days of the current interval later. The result is a list of non-overlapping intervals where any overlaps in the input list have pushed out subsequent intervals.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of an <code>aggregate</code> clause construct can be seen <a href="19-l-cqlsyntaxdiagrams.html#aggregateClause">here</a>.</p>
</div>
<div class="paragraph">
<p>Note that in general, since the type of the aggregate expression is not known until the expression can be semantically analyzed, it may be necessary to provide a typed starting expression as illustrated in this example. The starting clause can be omitted if the type of the result can be inferred from the aggregate expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define FactorialOfFive:
  ({ 1, 2, 3, 4, 5 }) Num
    aggregate Result: Coalesce(Result, 1) * Num</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, since the starting clause is omitted, Result is initially <span class="kw">null</span>, and Coalesce must be used to provide the default value of 1, and the type of Integer will be inferred through the Coalesce. Note that although this example only computes the factorial of five, the expand operator could be used to generate a sequence of integers and used to construct a general factorial function.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-functions"><a class="anchor" href="#defining-functions"></a>13. Defining Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CQL provides for the definition of functions. A function in CQL is a named expression that is allowed to take any number of arguments, each of which has a name and a declared type.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of a function defintion can be seen <a href="19-l-cqlsyntaxdiagrams.html#functionDefinition">here</a>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define function "CumulativeDuration"(Intervals List&lt;Interval&lt;DateTime&gt;&gt;):
  Sum((collapse Intervals) X return all duration in days of X)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This statement defines a function named <span class="id">CumulativeDuration</span> that takes a single argument named <span class="id">Intervals</span> of type <span class="kw">List&lt;Interval&lt;DateTime&gt;&gt;</span>. The function returns the sum of duration in days of the collapsed intervals given. This function can then be used just as any other system-defined function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Encounters": [Encounter: "Inpatient Visit"]
define "CD": CumulativeDuration(Encounters E return E.period)</code></pre>
</div>
</div>
<div class="paragraph">
<p>These statements establish an expression named CD that computes the cumulative duration of inpatient encounters for a patient.</p>
</div>
<div class="paragraph">
<p>Within the library in which it is defined, a function can be invoked directly by name. When a function is defined in a referenced library, the local library alias must be used to invoke the function. For example, assuming a library with the above function definition and referenced with the local alias <span class="id">Core</span>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Encounters": [Encounter: "Inpatient Visit"]
define "CD": Core.CumulativeDuration(Encounters E return E.period)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <span class="id">CumulativeDuration</span> function must be invoked using the local library alias <span class="id">Core</span>.</p>
</div>
<div class="paragraph">
<p>A syntax diagram of defining a function can be seen <a href="19-l-cqlsyntaxdiagrams.html#function">here</a>.</p>
</div>
<div class="paragraph">
<p>Functions can be defined that reference other functions anywhere within any library and to any degree of nesting, so long as the reference does not result in a circular reference.</p>
</div>
<div class="sect2">
<h3 id="operator-functions"><a class="anchor" href="#operator-functions"></a>13.1. Operator Functions</h3>
<div class="paragraph">
<p>Operator functions are system functions defined to support the behavior of operators defined in the language. For example, the addition operator (<span class="sym">+</span>) is implemented by the <span class="id">Add</span> function. Each operator defined in the language has a corresponding system-defined function that surfaces directly in the ELM. For a complete listing of these operators and their ELM function names, refer to the <a href="06-translationsemantics.html#functions">Functions</a> topic in the Translation Semantics chapter.</p>
</div>
<div class="paragraph">
<p>A consequence of having these system function definitions is that operators can also be invoked directly as functions. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">exists X
X = Y</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above expressions could also be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Exists(X)
Equal(X, Y)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fluent-functions"><a class="anchor" href="#fluent-functions"></a>13.2. Fluent Functions</h3>
<div class="quoteblock note-info">
<blockquote>
<div class="paragraph">
<p>Fluent functions are a new feature of CQL 1.5, and are trial-use.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Functions can be defined as <em>fluent</em> by including the <span class="kw">fluent</span> keyword as part of the function definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define fluent function "confirmed"(Conditions List&lt;Condition&gt;):
  Conditions C where C.verificationStatus ~ "Condition Confirmed"

define fluent function "active"(Conditions List&lt;Condition&gt;):
  Conditions C where C.clinicalStatus ~ "Condition Active"
    and C.abatement is null

define fluent function "activeOrRecurring"(Conditions List&lt;Condition&gt;):
  Conditions C
    where C.clinicalStatus ~ "Condition Active"
      or C.clinicalStatus ~ "Condition Recurrence"
      or C.clinicalStatus ~ "Condition Relapse"</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <em>fluent</em> function means that it can be invoked using dot-notation (<code>.</code>), and the first argument to the function will be provided by the value of the left-side of the dot-invocation at that point. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Diabetes Conditions":
  [Condition: "Diabetes Mellitus"]

define "Confirmed and Active or Recurring Diabetes Conditions":
  Conditions.confirmed().activeOrRecurring()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of this example is the same as if the functions had been invoked normally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Confirmed and Active or Recurring Diabetes Conditions":
  activeOrRecurring(confirmed(Conditions))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In other words, all the Condition elements returned from the <span class="id">Diabetes Conditions</span> expression, where those conditions have a <span class="id">verificationStatus</span> of <span class="id">Condition Confirmed</span>, and a <span class="id">clinicalStatus</span> of <span class="id">Condition Active</span>, <span class="id">Condition Recurrence</span>, or <span class="id">Condition Relpase</span>.</p>
</div>
<div class="paragraph">
<p>A <em>fluent</em> function may also take multiple arguments where the first argument to the function will be provided by the value of the left-side of the dot-invocation at that point and the second argument can still be passed in. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define fluent function byClinicalStatus(Conditions List&lt;Condition&gt;, Concept status):
  Conditions C where C.clinicalStatus ~ status

// usage
define "Active Diabetes Conditions":
  "Diabetes Conditions".byClinicalStatus("Condition Active")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the result of this example is the same as if the function had been invoked normally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define "Active Diabetes Conditions":
  byClinicalStatus("Diabetes Conditions", "Condition Active")</code></pre>
</div>
</div>
<div class="paragraph">
<p>In other words, all the Condition elements returned from the <span class="id">Diabetes Conditions</span> expression, where those conditions have a <span class="id">clinicalStatus</span> of <span class="id">Condition Active</span>.</p>
</div>
<div class="quoteblock note-info">
<blockquote>
<div class="paragraph">
<p>Note that the examples in this section are adapted from the <a href="https://github.com/AHRQ-CDS/AHRQ-CDS-Connect-PAIN-MANAGEMENT-SUMMARY/blob/v0.3.2/src/cql/r4/CDS_Connect_Commons_for_FHIRv400.cql#L178">CDS Connect FHIR Commons</a> library.</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="external-functions"><a class="anchor" href="#external-functions"></a>13.3. External Functions</h3>
<div class="paragraph">
<p>Functions can also be defined as <em>external</em> to support the ability to import functionality defined in external libraries. If a function is defined external, the return type must be provided:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">define function "IsSubsumedBy"(code Code, subsumingCode Code) returns Boolean : external</code></pre>
</div>
</div>
<div class="paragraph">
<p>CQL does not prescribe the details for how external functions are resolved or implemented, only that an implementation must accept the arguments as specified by the signature, and is expected to return a value of the declared return type.</p>
</div>
<div class="paragraph">
<p>Take heed that although there may be use cases for which external functions are the best option, they are not without drawbacks. Chief among the drawbacks that arise when using external functions are the challenges associated with interoperability. Since external functions are implementation specific, CQL libraries that are authored relying on external functions are also implementation specific. Therefore, the use of external functions is discouraged because they hinder one of the foundational benefits of CQL, which is data exchange.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-fhirpath"><a class="anchor" href="#using-fhirpath"></a>14. Using FHIRPath</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FHIRPath is a general-purpose graph traversal language designed as a simple way to define paths on a hierarchical data model such as FHIR. The language is used within the FHIR specification to provide precise semantics for various items in the specification such as invariants and search parameter paths. Because of the general-purpose nature of FHIRPath, CQL uses the basic expression definition capabilities defined by FHIRPath for its core expression terms. In fact, the ANTLR grammar for CQL imports the FHIRPath grammar and relies on the semantics defined there to define the base expression functionality of CQL, in much the same way that XQuery utilizes XPath to define its expression capabilities. In other words, CQL is a superset of FHIRPath, meaning that any valid FHIRPath expression is also a valid CQL expression.</p>
</div>
<div class="paragraph">
<p>However, FHIRPath has various implicit conversions defined to simplify expression of common path traversal scenarios. Because CQL is a type-safe language, some of this functionality can optionally be restricted within CQL through the use of several language options, as described in the following sections.</p>
</div>
<div class="sect2">
<h3 id="path-traversal"><a class="anchor" href="#path-traversal"></a>14.1. Path Traversal</h3>
<div class="paragraph">
<p>Paths in FHIRPath are constructed by concatenating labels using a dot qualifier:</p>
</div>
<div class="paragraph">
<p>Patient.name.given</p>
</div>
<div class="paragraph">
<p>In this case, the path begins at the <span class="id">Patient</span> expression and accesses the <span class="id">name</span> property, followed by the <span class="id">given</span> property of each <span class="id">name</span>. Because the <span class="id">given</span> path invocation is targeting the list of names, the property access is invoked for each name in the list, resulting in a list of all the given elements for every name in the Patient.</p>
</div>
<div class="paragraph">
<p>However, because property access on a list may actually be the result of mistakenly expecting the property to be singular, this behavior can be disabled with the <em>disable-list-traversal</em> option.</p>
</div>
</div>
<div class="sect2">
<h3 id="list-promotion-and-demotion"><a class="anchor" href="#list-promotion-and-demotion"></a>14.2. List Promotion and Demotion</h3>
<div class="paragraph">
<p>In FHIRPath, all operations are defined to return collections, and operations that expect singleton values are defined to throw an error when they are invoked with collections containing multiple elements. In CQL, this behavior is implemented using list promotion and demotion.</p>
</div>
<div class="paragraph">
<p>Wherever an operator is defined to take a non-list-valued type as a parameter, list demotion allows the arguments to be list-valued and are implicitly converted to a singleton value using the <span class="kw">singleton from</span> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Patient.name.given + ' ' + Patient.name.family</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>disable-demotion</em> option controls whether or not this expression is valid. With the option enabled, the expression can be compiled, and will evaluate, so long as the run-time values of <span class="id">given</span> and <span class="id">family</span> contain only a single element. With the option disabled, this expression will no longer compile, and the list-valued arguments must be converted to a single value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Patient.name.given.single() + ' ' + Patient.name.family.single()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows the compiler to help the author determine whether a singular value is expected and appropriate, or if the author mistakenly assumed the attribute was singular, when in fact the data model allows multiple values.</p>
</div>
<div class="paragraph">
<p>See the <a href="#promotion-and-demotion">Promotion and Demotion</a> topic for more discussion on how CQL supports list promotion and demotion.</p>
</div>
</div>
<div class="sect2">
<h3 id="missing-information-1"><a class="anchor" href="#missing-information-1"></a>14.3. Missing Information</h3>
<div class="paragraph">
<p>FHIRPath traversal operations are defined such that only values that are present are returned. In other words, it does not define a <em>null</em> indicator to represent missing information. Instead, it uses the empty collection (<span class="sym">\{ }</span>) and propagates empty collections in expressions. In general, if the input to an operator or function is an empty collection, the result is an empty collection. This corresponds to the null propogation semantics of CQL, particularly with respect to the three-valued logic semantics of the logical operators.</p>
</div>
</div>
<div class="sect2">
<h3 id="type-resolution"><a class="anchor" href="#type-resolution"></a>14.4. Type Resolution</h3>
<div class="paragraph">
<p>The FHIRPath specification does not require strongly-typed interpretation. In particular, the resolution of property names can be deferred completely to run-time, allowing for flexible use of expressions such as <span class="id">.children()</span> and <span class="id">.descendents()</span>. However, because CQL is a strongly-typed language, these types of expressions are required to be resolved at compile-time.</p>
</div>
<div class="paragraph">
<p>For example, consider the following FHIRPath:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cql" data-lang="cql">Patient.children().name</code></pre>
</div>
</div>
<div class="paragraph">
<p>This expression returns a list of the name elements of all the children of the Patient instance. To accomplish this in CQL, the result of <span class="id">.children()</span> is a list of elements of choice types, where the types in the choice are the distinct set of types of child elements.</p>
</div>
<div class="paragraph">
<p>This approach enables the flexibility of FHIRPath expressions but still maintains compile-time type resolution.</p>
</div>
</div>
<div class="sect2">
<h3 id="method-invocation"><a class="anchor" href="#method-invocation"></a>14.5. Method Invocation</h3>
<div class="paragraph">
<p>The FHIRPath syntax is designed as a fluent API, meaning that operations are invoked using a dot-invocation syntax. This functionality is supported in CQL using a syntactic method construct, similar to a lambda function, that allows the invocation to be rewritten as an equivalent function call. The method definition is allowed to declare special variables such as <span class="id">$this</span> that can be addressed in the body of the method.</p>
</div>
<div class="paragraph">
<p>This mechanism is then used to implement the FHIRPath operators, which are rewritten via the lambda replacement as direct invocations of CQL. The detailed equivalents for all FHIRPath operations are defined in the <a href="16-i-fhirpathtranslation.html">FHIRPath Function Translation Appendix</a>.</p>
</div>
<div class="paragraph">
<p>The <em>disable-method-invocation</em> option controls whether or not method-style invocation is allowed in the translator.</p>
</div>
</div>
</div>
</div>


</div>


				</div>  <!-- /inner-wrapper -->
            </div>  <!-- /row -->
        </div>  <!-- /container -->

    </div>  <!-- /segment-content -->


	<div id="segment-footer" class="segment">  <!-- segment-footer -->
		<div class="container">  <!-- container -->
			<div class="inner-wrapper">
				<p>
        &copy; HL7.org 2014+. CQL (Release) (<a href="http://www.hl7.org/Special/committees/dss/index.cfm">Clinical Decision Support WG</a>). hl7.cql#1.5.2 generated on 2023-01-20 11:08:31 +1100
        <span style="color: #FFFF77">|
<!--               <a style="color: #81BEF7" href="http://services.w3.org/htmldiff?doc1=http%3A%2F%2Fcql.hl7.org%2FSTU2%2F<%rellink%>&amp;doc2=<%baseURL%><%rellink%>">Compare to STU2</a> | -->
               <a style="color: #81BEF7" rel="license" href="license.html">License</a> |
               <a style="color: #81BEF7" rel="history" href="http://cql.hl7.org/history.html">Version History</a> |
               <a style="color: #81BEF7" target="_blank" href="https://jira.hl7.org/issues">Propose a change</a>
        </span>
        </p>
			</div>  <!-- /inner-wrapper -->
		</div>  <!-- /container -->
	</div>  <!-- /segment-footer -->

	<div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
		<div class="container">  <!-- container -->
		</div>  <!-- /container -->
	</div>  <!-- /segment-post-footer -->

      <!-- JS and analytics only. -->
      <!-- Bootstrap core JavaScript
================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
<script src="dist/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
<script src="dist/bootstrap.min.js"> </script>
<script src="dist/respond.min.js"> </script>
<script src="dist/fhir.js"> </script>
<script src="dist/sidebar.js"> </script>
<script src="dist/prism.js"> </script>
<script src="dist/cql.js"> </script>

  <!-- Analytics Below
================================================== -->


<div id="feedly-mini" title="feedly Mini tookit"></div></body></html>
